<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackboard Module Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden border border-slate-200">

        <!-- Header -->
        <div class="bg-indigo-600 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <i class="fas fa-calendar-alt"></i> Blackboard Scheduler
                </h1>
                <p class="text-indigo-100 text-sm mt-1">Plan your semester modules.</p>
            </div>
            <!-- Navigation to Validator -->
            <a href="validator.html"
                class="bg-indigo-500 hover:bg-indigo-400 text-white text-sm font-semibold py-2 px-4 rounded transition-colors flex items-center gap-2">
                Validator Tool <i class="fas fa-arrow-right"></i>
            </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-0">

            <!-- Controls Sidebar -->
            <div class="p-6 bg-slate-50 border-b md:border-b-0 md:border-r border-slate-200 col-span-1">
                <form id="scheduleForm" onsubmit="event.preventDefault(); generateSchedule();">

                    <!-- Load Course Preset -->
                    <div class="mb-5">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                            Upload Schedule (.docx)
                        </label>
                        <input type="file" id="courseFile" accept=".docx" onchange="handleFileUpload(this)"
                            class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 mb-2">

                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-4">
                            Select Course
                        </label>
                        <select id="courseSelect" onchange="loadCoursePreset()" disabled
                            class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white disabled:bg-slate-100 disabled:text-slate-400">
                            <option value="">Upload a file first...</option>
                        </select>
                        <p class="text-xs text-slate-400 mt-1">Select a course to auto-fill start date & skips.</p>
                    </div>

                    <!-- Start Date -->
                    <div class="mb-5">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">First Class
                            Date</label>
                        <input type="date" id="startDate" required
                            class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-colors">
                    </div>

                    <!-- Due Date Logic -->
                    <div class="mb-5">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Due Day of
                            Week</label>
                        <select id="dueDay"
                            class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white mb-3">
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>

                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Due Time
                            (For Export)</label>
                        <input type="time" id="dueTime" value="23:59"
                            class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>

                    <!-- Skip Dates -->
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Skip Dates
                            (MM/DD/YY)</label>
                        <p class="text-xs text-slate-400 mb-2">Enter the exact CLASS date to skip.</p>
                        <textarea id="skipDates" rows="4" placeholder="11/23/25&#10;12/25/25"
                            class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono text-sm"></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col gap-2">
                        <button type="submit"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-play"></i> Generate
                        </button>
                        <button type="button" onclick="exportCSV()" id="exportBtn" disabled
                            class="w-full bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold py-2 px-4 rounded transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                    </div>
                </form>
            </div>

            <!-- Results Table -->
            <div class="p-0 col-span-2 bg-white max-h-[600px] overflow-y-auto">
                <div id="emptyState" class="h-full flex flex-col items-center justify-center text-slate-400 p-10">
                    <i class="fas fa-file-upload text-5xl mb-4 opacity-20"></i>
                    <p>Upload a .docx schedule to begin</p>
                </div>

                <table id="resultTable" class="w-full text-left border-collapse hidden">
                    <thead class="bg-slate-100 sticky top-0 shadow-sm">
                        <tr>
                            <th
                                class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                                Module</th>
                            <th
                                class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                                Class Date</th>
                            <th
                                class="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                                Due Date</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100">
                        <!-- Rows generated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Mammoth.js for .docx parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script>
        document.getElementById('startDate').valueAsDate = new Date();

        // Default empty schedule
        let semesterSchedule = [];

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (event) {
                const arrayBuffer = event.target.result;
                mammoth.convertToHtml({ arrayBuffer: arrayBuffer })
                    .then(displayResult)
                    .catch(handleError);
            };
            reader.readAsArrayBuffer(file);
        }

        function displayResult(result) {
            const html = result.value; // The generated HTML
            parseCourseHtml(html);
        }

        function handleError(err) {
            console.error(err);
            alert("Error parsing document: " + err.message);
        }

        function parseCourseHtml(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const table = doc.querySelector('table');

            if (!table) {
                alert("No table found in the document.");
                return;
            }

            semesterSchedule = [];
            const rows = Array.from(table.querySelectorAll('tr'));
            let currentDay = "";
            let rowIndex = 0;

            // Skipping header row if it contains "Course No." or "Day"
            if (rows.length > 0) {
                const firstRowText = rows[0].innerText.toLowerCase();
                if (firstRowText.includes("course") || firstRowText.includes("day")) {
                    rowIndex = 1;
                }
            }

            const codeArgs = /^[A-Z]{2,4}\d{3}\./; // Regex to detect course code

            for (; rowIndex < rows.length; rowIndex++) {
                const cells = rows[rowIndex].querySelectorAll('td');
                // If shifted, we might have 5 cols (missing Day). If normal, 6 cols.
                if (cells.length < 5) continue;

                let code, name, startDateRaw, skipRaw;

                // Check first cell to see if it's a Code or Day
                const cell0Text = cells[0].innerText.trim();

                if (codeArgs.test(cell0Text)) {
                    // It's a Course Code -> Shifted row (Day merged/missing)
                    code = cell0Text;
                    name = cells[1].innerText.trim();
                    startDateRaw = cells[2].innerText.trim();
                    skipRaw = cells[4] ? cells[4].innerText.trim() : "";
                } else {
                    // It's a Day (or empty day placeholder) -> Normal 6 columns
                    if (cells.length < 6) continue; // Must have 6 if not shifted

                    const dayText = cell0Text.replace(/[\n\r]+/g, " ").trim();
                    if (dayText) {
                        currentDay = dayText;
                    }

                    code = cells[1].innerText.trim();
                    name = cells[2].innerText.trim();
                    startDateRaw = cells[3].innerText.trim();
                    skipRaw = cells[5] ? cells[5].innerText.trim() : "";
                }

                if (!code || !startDateRaw) continue;

                // Clean up start date (MM/DD/YY -> YYYY-MM-DD)
                const startDate = parseDateToIso(startDateRaw);

                // Parse skips
                const skipDates = [];
                const distinctDates = new Set();
                const dateRegex = /(\d{1,2}\/\d{1,2}\/\d{2,4})/g;
                let match;
                while ((match = dateRegex.exec(skipRaw)) !== null) {
                    const iso = parseDateToIso(match[0]);
                    if (iso && !distinctDates.has(iso)) {
                        skipDates.push(iso);
                        distinctDates.add(iso);
                    }
                }

                if (startDate) {
                    semesterSchedule.push({
                        code: code,
                        name: `${name} (${currentDay})`,
                        startDate: startDate,
                        skipDates: skipDates
                    });
                }
            }

            populateCourseDropdown();
            alert(`Parsed ${semesterSchedule.length} courses from the document.`);
        }

        function parseDateToIso(dateStr) {
            // Expects MM/DD/YY or MM/DD/YYYY
            const parts = dateStr.trim().split(/[\/\-\.]/);
            if (parts.length !== 3) return null;

            let m = parseInt(parts[0], 10);
            let d = parseInt(parts[1], 10);
            let y = parseInt(parts[2], 10);

            if (isNaN(m) || isNaN(d) || isNaN(y)) return null;

            // Handle 2 digit year
            if (y < 100) y += 2000;

            // Return YYYY-MM-DD
            return `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        }

        function populateCourseDropdown() {
            const select = document.getElementById('courseSelect');
            select.innerHTML = '<option value="">Manual Input</option>';

            if (semesterSchedule.length === 0) {
                select.disabled = true;
                select.innerHTML = '<option value="">Upload a file first...</option>';
                return;
            }

            select.disabled = false;
            semesterSchedule.forEach(course => {
                const option = document.createElement('option');
                option.value = course.code;
                option.textContent = `${course.code} - ${course.name}`;
                select.appendChild(option);
            });
        }

        function loadCoursePreset() {
            const select = document.getElementById('courseSelect');
            const selectedCode = select.value;

            if (!selectedCode) return; // "Manual" selected

            const course = semesterSchedule.find(c => c.code === selectedCode);
            if (course) {
                // Set Start Date
                document.getElementById('startDate').value = course.startDate;

                // Set Skip Dates
                // Format YYYY-MM-DD to MM/DD/YY for the textarea
                const formattedSkips = course.skipDates.map(dateStr => {
                    const [y, m, d] = dateStr.split('-');
                    return `${m}/${d}/${y.slice(2)}`;
                }).join('\\n');

                document.getElementById('skipDates').value = formattedSkips;
            }
        }

        let generatedData = [];

        function parseDateString(dateStr) {
            const parts = dateStr.trim().split(/[-/.]/);
            if (parts.length !== 3) return null;
            let y, m, d;
            if (parts[0].length === 4) {
                y = parseInt(parts[0]);
                m = parseInt(parts[1]) - 1;
                d = parseInt(parts[2]);
            } else {
                m = parseInt(parts[0]) - 1;
                d = parseInt(parts[1]);
                y = parseInt(parts[2]);
                if (y < 100) y += 2000;
            }
            return new Date(y, m, d);
        }

        // Format to 12-hour time (e.g., 11:59 PM)
        function formatTime12(timeStr) {
            const [hours, mins] = timeStr.split(':');
            let h = parseInt(hours);
            const m = parseInt(mins);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12; // the hour '0' should be '12'
            return `${h}:${m.toString().padStart(2, '0')} ${ampm}`;
        }

        function formatDate(dateObj) {
            const y = dateObj.getFullYear().toString().slice(-2);
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return `${m}/${d}/${y}`;
        }

        function formatInternalCheck(dateObj) {
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getDayName(dateObj) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return days[dateObj.getDay()];
        }

        function generateSchedule() {
            const startDateInput = document.getElementById('startDate').value;
            const dueDayIndex = parseInt(document.getElementById('dueDay').value);
            const dueTimeInput = document.getElementById('dueTime').value;
            const skipInput = document.getElementById('skipDates').value;

            if (!startDateInput) {
                alert("Please select a start date.");
                return;
            }

            const skipDates = new Set();
            const tokens = skipInput.split(/[\n,]/);
            tokens.forEach(t => {
                const cleanT = t.trim();
                if (cleanT) {
                    const d = parseDateString(cleanT);
                    if (d && !isNaN(d)) {
                        skipDates.add(formatInternalCheck(d));
                    }
                }
            });

            const formattedTime = formatTime12(dueTimeInput);

            let currentDate = parseDateString(startDateInput);
            let moduleCount = 1;
            generatedData = [];

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            while (moduleCount <= 15) {
                const dateStrForCheck = formatInternalCheck(currentDate);

                if (skipDates.has(dateStrForCheck)) {
                    const row = document.createElement('tr');
                    row.className = "bg-red-50";
                    row.innerHTML = `
                        <td class="p-3 text-red-500 font-bold border-l-4 border-red-500">NO CLASS</td>
                        <td class="p-3 text-red-500">${formatDate(currentDate)} ${getDayName(currentDate)}</td>
                        <td class="p-3 text-slate-400 italic">Skipped</td>
                    `;
                    tbody.appendChild(row);

                    currentDate.setDate(currentDate.getDate() + 7);
                    continue;
                }

                const currentDayIndex = currentDate.getDay();
                let daysToAdd = (dueDayIndex - currentDayIndex + 7) % 7;

                let dueDate = new Date(currentDate);
                dueDate.setDate(dueDate.getDate() + daysToAdd);

                const dateStr = `${formatDate(dueDate)} ${getDayName(dueDate)}`;
                const dueDateTime = `${dateStr} ${formattedTime}`;

                generatedData.push({
                    module: `Module ${moduleCount}`,
                    classDate: `${formatDate(currentDate)} ${getDayName(currentDate)}`,
                    dueDate: dueDateTime
                });

                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50 transition-colors";
                row.innerHTML = `
                    <td class="p-3 font-medium text-slate-700">Module ${moduleCount}</td>
                    <td class="p-3 text-slate-600">${formatDate(currentDate)} ${getDayName(currentDate)}</td>
                    <td class="p-3 font-semibold text-indigo-600">${dueDateTime}</td>
                `;
                tbody.appendChild(row);

                moduleCount++;
                currentDate.setDate(currentDate.getDate() + 7);
            }

            document.getElementById('resultTable').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('exportBtn').disabled = false;
        }

        function exportCSV() {
            if (generatedData.length === 0) return;

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Module,Class Date,Due Date\n";

            generatedData.forEach(row => {
                csvContent += `${row.module},${row.classDate},${row.dueDate}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "blackboard_schedule.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>

</html>